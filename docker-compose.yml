
services:
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: mosquitto
    ports:
      - "1883:1883"
    volumes:
      - ./config/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    ulimits:
      nofile:
        soft: 300000
        hard: 300000
  emqx:
    image: emqx:5.8
    container_name: emqx
    ports:
      - "1884:1883"   # MQTT TCP
      - "18084:18083" # Dashboard (optional)
    environment:
      - EMQX_ALLOW_ANONYMOUS=true
      - EMQX_AUTHORIZATION__NO_MATCH=allow
      - EMQX_LOG__LEVEL=info
      - EMQX_MQTT__MAX_PACKET_SIZE=10MB
    ulimits:
      nofile:
        soft: 300000
        hard: 300000
  hivemq:
    image: hivemq/hivemq-ce:latest
    container_name: hivemq
    ports:
      - "1885:1883"   # MQTT TCP
      - "8081:8080"   # Dashboard (optional)
    ulimits:
      nofile:
        soft: 300000
        hard: 300000
  rabbitmq:
    image: rabbitmq:4-management
    container_name: rabbitmq
    # Enable MQTT plugin and start server
    command: ["bash", "-lc", "rabbitmq-plugins enable --offline rabbitmq_mqtt; rabbitmq-server"]
    volumes:
      - ./config/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
      - "1886:1883"   # MQTT plugin (host port 1886 to avoid clashing with other brokers)
    ulimits:
      nofile:
        soft: 300000
        hard: 300000
  artemis:
    image: apache/activemq-artemis:latest-alpine
    container_name: artemis
    environment:
      - ARTEMIS_USER=admin
      - ARTEMIS_PASSWORD=admin
    ports:
      - "5673:5672"   # AMQP 1.0 (host 5673 to avoid RabbitMQ 5672)
      - "1887:1883"   # MQTT (host 1887; Artemis MQTT)
      - "61616:61616" # OpenWire
      - "61614:61613" # STOMP (host 61614)
      - "8161:8161"   # Web console
    ulimits:
      nofile:
        soft: 300000
        hard: 300000
  nats:
    image: nats:2
    container_name: nats
    command: ["-c", "/etc/nats/nats.conf"]
    ports:
      - "4222:4222"   # NATS TCP
    volumes:
      - ./config/nats.conf:/etc/nats/nats.conf:ro
    ulimits:
      nofile:
        soft: 300000
        hard: 300000
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    ulimits:
      nofile:
        soft: 300000
        hard: 300000

  router1:
    image: eclipse/zenoh-bridge-mqtt:1.6.2
    container_name: router1
    command: ["-c", "/etc/zenoh/router1.json5"]
    ports:
      - "7447:7447" # TCP listener exposed to host
      - "1888:1883" # MQTT plugin listener (router1)
    volumes:
      - ./config/router1.json5:/etc/zenoh/router1.json5:ro
    environment:
      RUST_LOG: info
    ulimits:
      nofile:
        soft: 300000
        hard: 300000

  # router2:
  #   image: eclipse/zenoh-bridge-mqtt:1.6.1
  #   container_name: router2
  #   command: ["-c", "/etc/zenoh/router2.json5"]
  #   ports:
  #     - "7448:7447" # expose TCP listener to host for router2
  #     # - "1889:1883" # MQTT plugin listener (router2)
  #   volumes:
  #     - ./config/router2.json5:/etc/zenoh/router2.json5:ro
  #   environment:
  #     RUST_LOG: info
  #   ulimits:
  #     nofile:
  #       soft: 65535
  #       hard: 65535

  # router3:
  #   deploy:
  #     replicas: 0
  #   image: eclipse/zenoh-bridge-mqtt:1.6.1
  #   container_name: router3
  #   command: ["-c", "/etc/zenoh/router3.json5"]
  #   ports:
  #     - "7449:7447" # expose TCP listener to host for router3
  #     # - "1890:1883" # MQTT plugin listener (router3)
  #   volumes:
  #     - ./config/router3.json5:/etc/zenoh/router3.json5:ro
  #   environment:
  #     RUST_LOG: info
  #   ulimits:
  #     nofile:
  #       soft: 65535
  #       hard: 65535